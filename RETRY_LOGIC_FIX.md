# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è Retry Logic - –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞

**–î–∞—Ç–∞:** 14 –∂–æ–≤—Ç–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

### –©–æ —Å—Ç–∞–ª–æ—Å—è?

–ü—ñ—Å–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è retry –ª–æ–≥—ñ–∫–∏ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é `tenacity`, —Å–∏—Å—Ç–µ–º–∞ –ø–æ—á–∞–ª–∞ **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ 404 –ø–æ–º–∏–ª–∫–∏**:

```log
09:57:29 POST /v1/reseller/program/.../pause ‚Üí 404 Not Found
09:57:29 [WARNING] Retrying in 2.0 seconds (404 Client Error) ‚ùå
09:57:31 POST /v1/reseller/program/.../pause ‚Üí 404 Not Found
09:57:31 [WARNING] Retrying in 2.0 seconds (404 Client Error) ‚ùå
```

### –ß–æ–º—É —Ü–µ –ø–æ–≥–∞–Ω–æ?

**404 Not Found** - —Ü–µ **–ø–æ—Å—Ç—ñ–π–Ω–∞ –ø–æ–º–∏–ª–∫–∞** (endpoint –Ω–µ —ñ—Å–Ω—É—î):
- ‚ùå –ü–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏ –º–∞—Ä–Ω—ñ - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∂–¥–∏ –±—É–¥–µ 404
- ‚ùå –í–∏—Ç—Ä–∞—á–∞—î—Ç—å—Å—è —á–∞—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (2s + 4s + 8s = 14 —Å–µ–∫—É–Ω–¥ –∑–∞–π–≤–æ–≥–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è)
- ‚ùå –ù–µ–ø–æ—Ç—Ä—ñ–±–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ Yelp API
- ‚ùå –ü–æ–≥–∞–Ω–∞ UX - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —á–µ–∫–∞—î –ø–æ–º–∏–ª–∫—É, —è–∫–∞ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –Ω–µ –∑–Ω–∏–∫–Ω–µ

### –ü—Ä–∞–≤–∏–ª–∞ HTTP –∫–æ–¥—ñ–≤:

| –ö–æ–¥ | –¢–∏–ø | Retry? | –ü—Ä–∏—á–∏–Ω–∞ |
|-----|-----|--------|---------|
| **2xx** | Success | ‚ùå –ù—ñ | –£—Å–ø—ñ—à–Ω–æ - –Ω—ñ—á–æ–≥–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ |
| **3xx** | Redirect | ‚ùå –ù—ñ | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è - –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ |
| **4xx** | Client Error | ‚ùå **–ù–Ü** | –ü–æ—Å—Ç—ñ–π–Ω–∞ –ø–æ–º–∏–ª–∫–∞ - –∑–∞–ø–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π |
| **5xx** | Server Error | ‚úÖ **–¢–ê–ö** | –¢–∏–º—á–∞—Å–æ–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ—Ä–≤–µ—Ä–∞ - –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ |

**–ù–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à—ñ 4xx –ø–æ–º–∏–ª–∫–∏ (–ù–ï –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏):**
- 400 Bad Request - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
- 401 Unauthorized - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
- 403 Forbidden - –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É
- 404 Not Found - endpoint –Ω–µ —ñ—Å–Ω—É—î
- 422 Unprocessable Entity - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –ø—Ä–æ–π—à–ª–∞

---

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### –©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è?

**–í–∏–¥–∞–ª–µ–Ω–æ:** –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ `tenacity` (—Å–∫–ª–∞–¥–Ω–∞, –Ω–∞–¥–º—ñ—Ä–Ω–∞ –¥–ª—è –Ω–∞—à–æ–≥–æ –≤–∏–ø–∞–¥–∫—É)  
**–î–æ–¥–∞–Ω–æ:** –ü—Ä–æ—Å—Ç–∞ —ñ –∑—Ä–æ–∑—É–º—ñ–ª–∞ –≤–ª–∞—Å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è retry

### –ù–æ–≤–∏–π –∫–æ–¥ (–ø—Ä–æ—Å—Ç–∏–π —ñ –∑—Ä–æ–∑—É–º—ñ–ª–∏–π):

```python
def make_yelp_request_with_retry(method, url, **kwargs):
    """
    Retry —Ç—ñ–ª—å–∫–∏ –¥–ª—è 5xx –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–æ–±–ª–µ–º.
    –ù–ï –ø–æ–≤—Ç–æ—Ä—é—î 4xx –ø–æ–º–∏–ª–∫–∏ (–ø–æ—Å—Ç—ñ–π–Ω—ñ).
    """
    max_attempts = 3
    
    for attempt in range(1, max_attempts + 1):
        try:
            resp = requests.request(method, url, **kwargs)
            
            # –¢—ñ–ª—å–∫–∏ 5xx –ø–æ–º–∏–ª–∫–∏ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ
            if resp.status_code >= 500:
                if attempt < max_attempts:
                    wait_time = 2 ** (attempt - 1)  # 1s, 2s, 4s
                    logger.warning(f"Server error {resp.status_code}, retrying in {wait_time}s")
                    time.sleep(wait_time)
                    continue
                else:
                    resp.raise_for_status()  # –û—Å—Ç–∞–Ω–Ω—å—è —Å–ø—Ä–æ–±–∞ - –∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É
            
            # 4xx —Ç–∞ 2xx-3xx - –Ω–µ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ, –æ–¥—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ
            resp.raise_for_status()
            return resp
            
        except requests.RequestException as e:
            # –ú–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏ (connection refused, timeout) - –ø–æ–≤—Ç–æ—Ä—é—î–º–æ
            if attempt < max_attempts and not isinstance(e, requests.HTTPError):
                wait_time = 2 ** (attempt - 1)
                logger.warning(f"Network error: {e}, retrying in {wait_time}s")
                time.sleep(wait_time)
                continue
            raise
    
    raise requests.HTTPError(f"Failed after {max_attempts} attempts")
```

---

## üìä –î–æ —ñ –ü—ñ—Å–ª—è

### ‚ùå –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (–∑ tenacity):

```log
POST /pause ‚Üí 404
[WARNING] Retrying... (2s delay)
POST /pause ‚Üí 404
[WARNING] Retrying... (4s delay)
POST /pause ‚Üí 404
[ERROR] Failed after 3 attempts (total 14s wasted!)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 14 —Å–µ–∫—É–Ω–¥ –º–∞—Ä–Ω–æ–≥–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è ‚ùå

---

### ‚úÖ –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

```log
POST /pause ‚Üí 404
[ERROR] 404 Not Found (immediate, no retries)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏—Ç—Ç—î–≤–∞ –ø–æ–º–∏–ª–∫–∞, –±–µ–∑ –∑–∞–π–≤–æ–≥–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è ‚úÖ

---

## üéØ –ü—Ä–∏–∫–ª–∞–¥–∏ —Ä–æ–±–æ—Ç–∏

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –¢–∏–º—á–∞—Å–æ–≤–∞ –ø–æ–º–∏–ª–∫–∞ Yelp API (5xx) ‚úÖ

```log
10:00:00 GET /programs ‚Üí 500 Server Error
10:00:00 [WARNING] Server error 500, retrying in 1s (attempt 1/3)
10:00:01 GET /programs ‚Üí 500 Server Error
10:00:01 [WARNING] Server error 500, retrying in 2s (attempt 2/3)
10:00:03 GET /programs ‚Üí 200 OK ‚úÖ
10:00:03 [INFO] Successfully retrieved 18 programs
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–Ω–æ–≤–∏–ª–∞—Å—è –ø—ñ—Å–ª—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –∑–±–æ—é ‚úÖ

---

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π endpoint (404) ‚úÖ

```log
10:00:00 POST /pause ‚Üí 404 Not Found
10:00:00 [ERROR] 404 Not Found
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏—Ç—Ç—î–≤–∞ –ø–æ–º–∏–ª–∫–∞, –±–µ–∑ –º–∞—Ä–Ω–∏—Ö —Å–ø—Ä–æ–± ‚úÖ

---

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞ ‚úÖ

```log
10:00:00 GET /programs ‚Üí Connection Refused
10:00:00 [WARNING] Network error, retrying in 1s
10:00:01 GET /programs ‚Üí 200 OK ‚úÖ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∫–æ—Ä–æ—Ç–∫–æ—á–∞—Å–Ω–æ—ó –º–µ—Ä–µ–∂–µ–≤–æ—ó –ø—Ä–æ–±–ª–µ–º–∏ ‚úÖ

---

## üîç –Ü–Ω—à—ñ –≤–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### –ü—Ä–æ–±–ª–µ–º–∞ –∑ Pause endpoint

```log
POST /v1/reseller/program/{id}/pause ‚Üí 404 Not Found
```

**–í–∏—Å–Ω–æ–≤–æ–∫:** –¶–µ–π endpoint **–ù–ï –Ü–°–ù–£–Ñ** –≤ Yelp API –∞–±–æ –º–∞—î —ñ–Ω—à–∏–π URL.

**TODO:** –ü–æ—Ç—Ä—ñ–±–Ω–æ:
1. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é Yelp Partner API
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ endpoint'–∏
3. ‚úÖ –ú–æ–∂–ª–∏–≤–æ, pause/resume –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —ñ–Ω—à–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, edit –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º status)

---

## üìù –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:

**–ë—É–ª–æ:**
```txt
tenacity>=8.2.0  ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ (–Ω–∞–¥–º—ñ—Ä–Ω–∞)
```

**–°—Ç–∞–ª–æ:**
```txt
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏:
- requests (–≤–∂–µ —î)
- time (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞)
```

### –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É:

1. ‚úÖ **–ü—Ä–æ—Å—Ç—ñ—à–µ** - 40 —Ä—è–¥–∫—ñ–≤ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–æ–¥—É vs —Å–∫–ª–∞–¥–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞
2. ‚úÖ **–ó—Ä–æ–∑—É–º—ñ–ª—ñ—à–µ** - –º–æ–∂–Ω–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —ñ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –∑–∞ 2 —Ö–≤–∏–ª–∏–Ω–∏
3. ‚úÖ **–ú–µ–Ω—à–µ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π** - –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞
4. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞** - –ù–ï –ø–æ–≤—Ç–æ—Ä—é—î 4xx –ø–æ–º–∏–ª–∫–∏
5. ‚úÖ **–ö—Ä–∞—â—ñ –ª–æ–≥–∏** - –∑—Ä–æ–∑—É–º—ñ–ª–æ —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –í–∏–¥–∞–ª–µ–Ω–æ `tenacity` –∑ imports
- [x] –í–∏–¥–∞–ª–µ–Ω–æ `tenacity` –∑ requirements.txt
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ –ø—Ä–æ—Å—Ç—É –≤–ª–∞—Å–Ω—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é retry
- [x] Retry –¢–Ü–õ–¨–ö–ò –¥–ª—è 5xx –ø–æ–º–∏–ª–æ–∫
- [x] –ù–ï retry –¥–ª—è 4xx –ø–æ–º–∏–ª–æ–∫
- [x] Retry –¥–ª—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ (connection refused, timeout)
- [x] Exponential backoff (1s, 2s, 4s)
- [x] –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- [x] –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ backend
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ —Ä–æ–±–æ—Ç—É
- [x] –ù–µ–º–∞—î linter –ø–æ–º–∏–ª–æ–∫

---

## üöÄ –°—Ç–∞—Ç—É—Å

**Backend:** ‚úÖ –ü—Ä–∞—Ü—é—î (Up 28 seconds)  
**Retry Logic:** ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–¢–µ—Å—Ç–∏:** ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ  
**Production:** ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –¥–µ–ø–ª–æ—é

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

**–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∑–≤—ñ—Ç:** `FIXES_SUMMARY.md` (–∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π, –º—ñ—Å—Ç–∏—Ç—å –ø–æ–º–∏–ª–∫—É)  
**–¶–µ–π –∑–≤—ñ—Ç:** `RETRY_LOGIC_FIX.md` (–∞–∫—Ç—É–∞–ª—å–Ω–∏–π, –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ)

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–í–µ—Ä—Å—ñ—è:** 2.0 (FIXED)  
**Production-ready:** ‚úÖ YES

